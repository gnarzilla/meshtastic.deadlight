<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEADLIGHT // MESH</title>
    
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    
    <style>
        :root {
            --bg: #080b09;
            --panel: #0f1510;
            --border: #1a2e1d;
            --text-main: #d4e8d0;
            --text-dim: #4d7a52;
            --accent: #22c55e;
            --accent-dim: #15803d;
            --log-bg: #050805;

            /* Log Colors â€” shifted green-ward to match palette */
            --l-info: #34d399;
            --l-warn: #fbbf24;
            --l-err:  #f87171;
            --l-debug: #374a39;
            --l-time: #4ade80;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
            /* Subtle scanline texture to evoke RF/radio feel */
            background-image: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(34, 197, 94, 0.015) 2px,
                rgba(34, 197, 94, 0.015) 4px
            );
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }
        h1 { margin: 0; font-size: 20px; letter-spacing: -1px; }
        .badge { 
            background: var(--accent);
            color: #000; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: bold;
        }

        /* STATS GRID */
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        /* Subtle left accent bar on cards */
        .card::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 2px;
            background: var(--accent-dim);
        }
        .card-label { 
            color: var(--text-dim); 
            font-size: 11px; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
            margin-bottom: 5px; 
            display: block;
        }
        .card-value { font-size: 24px; font-weight: 600; color: var(--accent); }

        /* WORKSPACE */
        .workspace {
            display: flex;
            flex: 1;
            gap: 20px;
            overflow: hidden;
        }

        /* MESH LINKS PANEL (Left) */
        .conn-panel {
            flex: 1;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
        }
        .panel-head {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-dim);
            letter-spacing: 0.08em;
        }
        .panel-head span:first-child { color: var(--text-main); }

        .conn-list {
            overflow-y: auto;
            flex: 1;
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .conn-row {
            padding: 8px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            display: grid;
            grid-template-columns: 40px 1fr 90px;
            gap: 10px;
            align-items: center;
        }
        .conn-row:hover { background: #0d1a0f; }
        .conn-row .proto-tag { color: var(--text-dim); font-size: 10px; }
        .active-count { color: var(--accent); font-weight: bold; text-align: right; }

        /* LOG TERMINAL (Right) */
        .terminal-panel {
            flex: 2;
            background: var(--log-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            font-size: 12px;
        }
        .terminal-window {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
        }
        
        .log-line { 
            display: block; 
            margin-bottom: 2px; 
            line-height: 1.4; 
            border-left: 2px solid transparent; 
            padding-left: 5px;
        }
        .log-line:hover { background: #0a110a; border-left-color: var(--text-dim); }
        
        .ts  { color: var(--l-time); opacity: 0.6; margin-right: 10px; }
        .lvl-INFO  { color: var(--l-info);  font-weight: bold; }
        .lvl-WARN  { color: var(--l-warn);  font-weight: bold; }
        .lvl-ERROR { color: var(--l-err);   font-weight: bold; }
        .lvl-DEBUG { color: var(--l-debug); }
        .msg { color: var(--text-main); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* STATUS INDICATORS */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }
        .status-online     { background: var(--accent); }
        .status-offline    { background: #ef4444; animation: none; }
        .status-connecting { background: #fbbf24; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.35; }
        }

        .stream-mode {
            font-size: 10px;
            color: var(--text-dim);
            margin-left: 5px;
            letter-spacing: 0.05em;
        }

        /* Antenna icon pulse ring â€” purely decorative */
        .icon-wrap {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }
        .icon-wrap::after {
            content: '';
            position: absolute;
            width: 36px; height: 36px;
            border-radius: 50%;
            border: 1px solid var(--accent);
            opacity: 0;
            animation: sonar 3s ease-out infinite;
        }
        @keyframes sonar {
            0%   { transform: scale(0.4); opacity: 0.6; }
            100% { transform: scale(1.4); opacity: 0; }
        }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <!-- Antenna / broadcast icon -->
            <div class="icon-wrap">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" 
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                     style="color: var(--accent)">
                    <!-- vertical mast -->
                    <line x1="12" y1="24" x2="12" y2="10"/>
                    <!-- signal arcs -->
                    <path d="M8.5 6.5 A5 5 0 0 1 15.5 6.5"/>
                    <path d="M5.5 3.5 A9 9 0 0 1 18.5 3.5"/>
                    <!-- base dot -->
                    <circle cx="12" cy="10" r="1.2" fill="currentColor"/>
                </svg>
            </div>
            <h1>DEADLIGHT <span style="opacity:0.4">//</span> MESH</h1>
            <span class="stream-mode" id="mode-indicator">âš¡ REALTIME</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <span class="badge">v1.0.0</span>
            <span class="badge" id="api-status-badge" 
                  style="background:#1a2e1d; color: var(--text-dim); border: 1px solid var(--border);">
                <span class="status-indicator status-connecting"></span>CONNECTING...
            </span>
        </div>
    </header>

    <!-- METRICS -->
    <div class="grid">
        <div class="card">
            <span class="card-label">Active Links</span>
            <span class="card-value" id="val-active">--</span>
        </div>
        <div class="card">
            <span class="card-label">Packets Relayed</span>
            <span class="card-value" id="val-total">--</span>
        </div>
        <div class="card">
            <span class="card-label">Bytes Bridged</span>
            <span class="card-value" id="val-bytes">--</span>
        </div>
        <div class="card">
            <span class="card-label">Gateway Uptime</span>
            <span class="card-value" id="val-uptime">--</span>
        </div>
    </div>

    <div class="workspace">
        <!-- LEFT: MESH LINKS -->
        <div class="conn-panel">
            <div class="panel-head">
                <span>MESH LINKS</span>
                <span style="font-size: 10px;">LIVE</span>
            </div>
            <ul class="conn-list" id="conn-list">
                <li class="conn-row" style="text-align:center; display:block; opacity:0.4; padding:20px;">
                    Awaiting mesh telemetry...
                </li>
            </ul>
        </div>

        <!-- RIGHT: GATEWAY LOG -->
        <div class="terminal-panel">
            <div class="panel-head">
                <span>GATEWAY LOG</span>
                <div style="display:flex; gap:10px; align-items:center;">
                    <label style="font-size:10px; cursor:pointer;">
                        <input type="checkbox" checked id="auto-scroll"> AUTO-SCROLL
                    </label>
                </div>
            </div>
            <div class="terminal-window" id="terminal"></div>
        </div>
    </div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIG
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const API_BASE    = 'http://127.0.0.1:8080';
    const SSE_ENDPOINT = API_BASE + '/api/stream';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let lastLogLine       = '';
    let eventSource       = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_DELAY = 30000;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatUptime(seconds) {
        if (!seconds) return '0s';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return `${h}h ${m}m ${s}s`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function renderLogLine(line) {
        const regex = /^(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2})\s\[\s*([A-Z]+)\s*\]\s(.*)/;
        const match = line.match(regex);

        if (!match) {
            return `<div class="log-line"><span class="msg">${escapeHtml(line)}</span></div>`;
        }

        const [_, ts, level, msg] = match;

        // Keyword highlighting â€” mesh-flavoured colours
        let richMsg = escapeHtml(msg)
            .replace(/(Connection \d+)/g,              '<span style="color:#6ee7b7">$1</span>')
            .replace(/([a-zA-Z0-9.-]+\.com:\d+)/g,    '<span style="color:#fcd34d">$1</span>')
            .replace(/(direct:\/\/)/g,                 '<span style="color:#86efac">$1</span>')
            .replace(/(LoRa|mesh|fragment|relay)/gi,   '<span style="color:#4ade80">$1</span>');

        return `
            <div class="log-line">
                <span class="ts">${ts}</span>
                <span class="lvl-${level.trim()}">[${level}]</span>
                <span class="msg" style="margin-left:10px">${richMsg}</span>
            </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATUS BADGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function updateApiStatus(status) {
        const badge = document.getElementById('api-status-badge');

        if (status === 'online') {
            badge.innerHTML = '<span class="status-indicator status-online"></span>STREAMING';
            badge.style.background = 'var(--accent)';
            badge.style.color = '#000';
            badge.style.border = 'none';
            reconnectAttempts = 0;
        } else if (status === 'connecting') {
            badge.innerHTML = '<span class="status-indicator status-connecting"></span>CONNECTING...';
            badge.style.background = '#1a2e1d';
            badge.style.color = '#fbbf24';
            badge.style.border = '1px solid var(--border)';
        } else {
            const retryIn = Math.min(2 ** reconnectAttempts, 30);
            badge.innerHTML = `<span class="status-indicator status-offline"></span>OFFLINE (retry ${retryIn}s)`;
            badge.style.background = '#1a0a0a';
            badge.style.color = '#f87171';
            badge.style.border = '1px solid #3a1a1a';
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DASHBOARD UPDATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function updateDashboard(data) {
        const metrics = data.metrics;

        document.getElementById('val-active').innerText =
            metrics.active_connections + ' / ' + metrics.total_connections;
        document.getElementById('val-total').innerText  = metrics.total_connections;
        document.getElementById('val-bytes').innerText  = formatBytes(metrics.bytes_transferred);
        document.getElementById('val-uptime').innerText = formatUptime(metrics.uptime);

        // Mesh links â€” protocol breakdown
        const list = document.getElementById('conn-list');
        let html = '';
        let hasActive = false;

        for (const [proto, stats] of Object.entries(metrics.protocols)) {
            if (stats.active > 0) {
                hasActive = true;
                html += `
                <li class="conn-row">
                    <span class="proto-tag">LNK</span>
                    <span style="font-weight:bold">${proto}</span>
                    <span class="active-count">${stats.active} ACTIVE</span>
                </li>`;
            }
        }

        list.innerHTML = hasActive
            ? html
            : '<li class="conn-row" style="opacity:0.4; justify-content:center; display:block; padding:20px; text-align:center;">No active links</li>';

        // Logs â€” incremental append
        const logs = data.logs || [];
        const term = document.getElementById('terminal');

        let newLogs = [];
        if (lastLogLine === '') {
            newLogs = logs;
        } else {
            const idx = logs.indexOf(lastLogLine);
            newLogs = idx !== -1 ? logs.slice(idx + 1) : logs;
        }

        if (newLogs.length > 0) {
            lastLogLine = logs[logs.length - 1];

            newLogs.forEach(line => {
                const div = document.createElement('div');
                div.innerHTML = renderLogLine(line);
                term.appendChild(div);
            });

            if (document.getElementById('auto-scroll').checked) {
                term.scrollTop = term.scrollHeight;
            }

            while (term.childElementCount > 500) {
                term.removeChild(term.firstChild);
            }
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SSE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function connectSSE() {
        updateApiStatus('connecting');
        eventSource = new EventSource(SSE_ENDPOINT);

        eventSource.addEventListener('dashboard', (event) => {
            try {
                updateDashboard(JSON.parse(event.data));
                updateApiStatus('online');
            } catch (err) {
                console.error('[SSE] Parse error:', err);
            }
        });

        eventSource.onopen = () => {
            updateApiStatus('online');
            reconnectAttempts = 0;
        };

        eventSource.onerror = () => {
            eventSource.close();
            updateApiStatus('offline');
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), MAX_RECONNECT_DELAY);
            setTimeout(connectSSE, delay);
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // POLLING FALLBACK
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function switchToPollingMode() {
        document.getElementById('mode-indicator').textContent = 'ğŸ”„ POLLING';
        if (eventSource) { eventSource.close(); eventSource = null; }

        async function poll() {
            try {
                const res  = await fetch(API_BASE + '/api/dashboard');
                if (!res.ok) throw new Error(`${res.status}`);
                updateDashboard(await res.json());
                updateApiStatus('online');
            } catch {
                updateApiStatus('offline');
            }
        }

        poll();
        setInterval(poll, 3000);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    if (typeof EventSource !== 'undefined') {
        connectSSE();
        setTimeout(() => { if (reconnectAttempts > 10) switchToPollingMode(); }, 60000);
    } else {
        switchToPollingMode();
    }

    window.addEventListener('beforeunload', () => { if (eventSource) eventSource.close(); });
</script>
</body>
</html>